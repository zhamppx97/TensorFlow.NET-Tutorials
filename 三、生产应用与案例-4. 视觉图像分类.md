# [C# TensorFlow 2 入门教程](<https://github.com/SciSharp/TensorFlow.NET-Tutorials>)

# 三、生产应用与案例

## 4. 视觉图像分类

除了特定的读码和测量外，机器视觉检测领域的三大主要任务为图像分类、目标检测和图像分割。自从深度学习方法引入到机器视觉行业，经过这些年的飞速发展，从早期的图像分类一直到后来的目标检测和图像分割，深度学习逐渐在机器视觉领域占据绝对的主导地位。我们可以通过下图来快速了解区分“图像分类、目标检测和图像分割”这3种不同的视觉检测任务：

<img src="三、生产应用与案例-4. 视觉图像分类.assets/image-20210214001821495.png" alt="image-20210214001821495" style="zoom:80%;" />

本章节我们主要讲解深度学习在视觉领域的最基础应用-图像分类，简单地说，图像分类就是要回答上图左1的这张图片是一只猫的问题。

对于人类来说，这是一个非常自然而然的事情，我们每天都在做大量的图像分类任务，从早晨起床识别衣服进行穿衣，识别各种早餐和餐具进行就餐，识别马路上的车辆、交通标识和行人，到达工作场所后识别各种文件和物体……我们几乎没有意识到自己每天都在完成大量的图像分类任务。

这个看似非常简单的事情，对于计算机视觉来说，却并没有这么容易。因为对于计算机而言，它们是无法像人一样看到整张图片并进行直观理解的，计算机看到的只是一个3维矩阵，包含“长×宽×通道数”个像素点，每个像素点的灰度值在0（纯黑）~255（纯白）之间，计算机需要根据这么多的像素点灰度的值进行逻辑运算，最后判定给出图像的分类标签。下图描述了计算机看到的图片：

<img src="三、生产应用与案例-4. 视觉图像分类.assets/image-20210214010255264.png" alt="image-20210214010255264" style="zoom:80%;" />

计算机在实际识别的过程中，会遇到很多复杂的情况和困难，比如：物体旋转或尺寸缩放、图像变形或拍摄视角影响、光影变换、复杂背景干扰等等，很多情况下，传统机器视觉的CV算法已经无法根据预设规则进行分类筛选。在这种传统机器视觉的瓶颈领域，正好是深度学习大展拳脚的时候，我们可以通过深度学习的图像分类算法模型，“喂”给模型大量的带已分类标签的图像，模型自己去总结和学习图像的特征，最终通过多轮训练得到一个指定任务的分类器，这个分类器可以准确地对未知的相同任务的图像进行分类。这就是深度学习的大致流程，而深度学习视觉图像分类领域，最流行也最基础的就是卷积神经网络（CNN）。

说到卷积神经网络（Convolutional Neural Network, CNN），我们肯定要知道卷积神经网络之父-Yann LeCun。在神经网络和深度学习领域，Yann LeCun 可以说是元老级人物。通过利用局部相关性和权值共享的思想，Yann Lecun 在1986年提出了卷积神经网络，并于1998年在 IEEE 上发表了一篇42页的长文，文中首次提出卷积-池化-全连接的神经网络结构，由 LeCun 提出的七层网络命名为 LeNet5。该网络模型的简略结构是“输入-卷积-池化-卷积-池化-卷积（全连接）-全连接-全连接（输出）”，如下图所示：

<img src="三、生产应用与案例-4. 视觉图像分类.assets/image-20210214012114638.png" alt="image-20210214012114638" style="zoom:67%;" />

卷积神经网络的模型结构和前面章节讲述的全连接网络类似，只是新加入了一些卷积层和池化层。全连接层在处理高维度的图片、视频数据时往往出现网络参数量巨大，训练非常困难的问题，而卷积神经网络的局部感受野和权值共享的特性可以很好地解决训练问题，随着深度学习的兴盛，卷积神经网络在机器视觉领域的表现大大超越了其它算法模型，呈现统治视觉领域之势。

通过增加、删除或者调整组合 CNN 网络的结构，我们可以得到很多的图像分类模型，其中比较流行的有 AlexNet、VGG、GoogLeNet、ResNet、DenseNet 等。同时很多常用的目标检测模型，例如 RCNN、Fast RCNN、Faster RCNN 等，也是基于 CNN 扩展而来，可以说，CNN 网络是深度学习视觉领域最重要的基石。





### 4.1 卷积神经网络（CNN）实现图像分类

**图像分类任务描述：**

我们通过手写字符集 MNIST 的图像分类识别，来演示一个简单的7层卷积神经网络。



**数据集简述：**

数据集是最为经典的 MNIST 手写字符集，在前文已经详细介绍该数据集的出处，此处不再赘述。

我们可以通过下述方法载入 MNIST 数据集，并查看该数据集的形状，其中变量 x_train，y_train，x_test，y_test 的类型为 NDArray ：

```c#
NDArray x_test, y_test, x_train, y_train;
((x_train, y_train), (x_test, y_test)) = keras.datasets.mnist.load_data();
```

你可以在VS里面设置断点查看变量的内容，我们看到训练集的大小是 60000 张图片和标签，测试集的大小是 10000 张图片和标签，每张图片的尺寸是 28 pixel × 28 pixel ：

<img src="三、生产应用与案例-4. 视觉图像分类.assets/image-20210217211134982.png" alt="image-20210217211134982" style="zoom:50%;" />

<img src="三、生产应用与案例-4. 视觉图像分类.assets/image-20210217211203178.png" alt="image-20210217211203178" style="zoom:50%;" />

<img src="三、生产应用与案例-4. 视觉图像分类.assets/image-20210217211045036.png" alt="image-20210217211045036" style="zoom:50%;" />

<img src="三、生产应用与案例-4. 视觉图像分类.assets/image-20210217211230449.png" alt="image-20210217211230449" style="zoom:50%;" />

你也可以通过 SharpCV 的 cv2.imshow() 方法显示图片进行查看，我们看到 0~9 这 10 个不同的手写字符，大致如下图所示：

<img src="三、生产应用与案例-4. 视觉图像分类.assets/image-20210217213807048.png" alt="image-20210217213807048" style="zoom:67%;" />



**网络模型搭建：**

我们通过使用 Keras 中的函数式 Functional 方式搭建一个简单的7层卷积神经网络。并使用 Keras 中内置的 model.compile() 进行模型编译，使用 model.fit() 进行模型训练，最后使用 model.evaluate() 进行模型评估。



**完整解决方案的代码实操：**

**① 创建解决方案**

创建新项目。

<img src="三、生产应用与案例-4. 视觉图像分类.assets/image-20210217215353989.png" alt="image-20210217215353989" style="zoom:67%;" />

选择 .NET Core 。

<img src="三、生产应用与案例-4. 视觉图像分类.assets/image-20210217215423134.png" alt="image-20210217215423134" style="zoom:67%;" />

输入项目名和项目路径，并点击创建项目。

<img src="三、生产应用与案例-4. 视觉图像分类.assets/image-20210217215634704.png" alt="image-20210217215634704" style="zoom:67%;" />

配置项目属性的 .NET 5.0 版本 和 编译器版本 x64 位。

<img src="三、生产应用与案例-4. 视觉图像分类.assets/image-20210217235904092.png" alt="image-20210217235904092" style="zoom:67%;" />

<img src="三、生产应用与案例-4. 视觉图像分类.assets/image-20210217215954572.png" alt="image-20210217215954572" style="zoom: 63%;" />



**② 添加类库引用**

通过 NuGet 安装最新版本的 TensorFlow.NET、SciSharp.TensorFlow.Redist（ GPU 版本对应的为SciSharp.TensorFlow.Redist-Windows-GPU ） 和 TensorFlow.Keras，安装完如下图所示：

<img src="三、生产应用与案例-4. 视觉图像分类.assets/image-20210217234946232.png" alt="image-20210217234946232" style="zoom:67%;" />

添加命名空间。

```c#
using NumSharp;
using Tensorflow.Keras.Engine;
using Tensorflow.Keras.Layers;
using static Tensorflow.KerasApi;
```



**③ 主程序代码**

























### 4.2 卷积神经网络详解







### 4.3 深入了解卷积神经网络





