# [C# TensorFlow 2 实战教程](<https://github.com/SciSharp/TensorFlow.NET-Tutorials>)

# 三、生产应用与案例

## 3. 工业生产环境应用案例

### 3.1 工业机器视觉领域应用

#### 3.1.1 工业机器视觉和机器学习简介

工业中为什么要导入机器视觉？

相比传统人眼检查，机器视觉有哪些优势呢？

工业中的机器视觉主要有下述3大优势：

1. **自动化 - 节约检查人力**
2. **速度快 - 提高生产效率**
3. **精度高 - 确保最优品质**

还有：恶劣危险环境使用；检查过程数据化；接入工厂大数据智能系统；Robot 快速交互；7\*24H 连续作业；测量和读码等人眼无法进行的作业；……

更重要的是，稳定。

传统机器视觉算法的历史要追溯到20世纪50年代，人们开始研究二维图像的统计模式识别。正式的机器视觉研究是从20世纪60年代中期美国学者 L.R.Roberts 关于理解多面体组成的积木世界的研究开始的。当时运用的预处理、边缘检测、轮廓线构成、对象建模、匹配等技术，后来一直在机器视觉中应用。而机器视觉这个名词的正式使用，来自70年代中的 MIT 人工智能实验室开设的“机器视觉”课程，1977 年，David Marr 提出了不同于“积木世界”分析方法的计算机视觉(computational vision)理论——也就是著名的 Marr 视觉理论，该理论在80 年代成为机器视觉研究领域中的一个十分重要的理论框架。

到了90年代，机器视觉理论得到进一步的发展，同时开始在工业领域得到应用。在“智能制造”高速发展的今天，机器视觉技术和机器人技术一起，在工业中已经被大量应用，帮助工业现场优化设备效率、提升产品品质和加速工业智能化进程，机器视觉的应用已经超越了其传统的检验领域，向着更深层、更为多样化的领域扩展。

<img src="%E9%99%84%E5%BD%95%EF%BC%9A1.%20TensorFlow.NET%20%E5%9C%A8%E5%B7%A5%E4%B8%9A%E5%BA%94%E7%94%A8%E4%B8%AD%E7%9A%84%E4%BC%98%E5%8A%BF.assets/1610680723391.png" alt="1610680723391" style="zoom:67%;" />

那么，在工业中，什么是机器视觉？

简单来说，**“机器视觉就是用机器代替人眼来做测量和判断。”**

完整地定义，在工业中，机器视觉就是通过机器视觉的硬件产品将被摄取目标转换成图像信号，传送给专用的图像处理系统，根据像素分布和亮度、颜色等信息，转变成数字化信号，图像系统对这些信号进行各种运算来抽取目标的特征，如面积、数量、位置、长度等，再根据预设的允许度和其他条件输出结果，例如尺寸、角度、个数、合格 / 不合格、有 / 无等，进而根据判别的结果来控制现场的设备动作或者输出数据和结果。



然而，在某些特定的领域，比如复杂背景下的复杂随机目标识别，和干扰环境下的误报警率高发，这些情况下，传统机器视觉算法达到了瓶颈，简单的算法逻辑出现了局限性，无法有效对特征进行表达。典型情况如下：

<img src="%E9%99%84%E5%BD%95%EF%BC%9A1.%20TensorFlow.NET%20%E5%9C%A8%E5%B7%A5%E4%B8%9A%E5%BA%94%E7%94%A8%E4%B8%AD%E7%9A%84%E4%BC%98%E5%8A%BF.assets/1610681703630.png" alt="1610681703630" style="zoom:67%;" />

这时候，深度学习就发挥出了优势。深度学习可以从大量的数据中学习到复杂的特征模型，最终精准地对复杂特征进行表达，进而精确地识别，例如对于上图准确表达出“产品表面不规则凹陷”这种特征。

 

在推进深度学习应用于工业现场的机器视觉项目的过程 中，我摸索尝试过各种解决方案，也深入地和现场使用人员交流，并对工业现场的视觉软硬件环境做了广泛的调研， 发现深度学习在工业应用场景和互联网消费领域应用存在一定的差异性。 但得益于 TensorFlow 优秀的性能和快速的模型训练部署，深度学习的建模上手起来感受非常舒适。使用 TensorFlow 以后，确实提升了生产现场的检查能力，提高了生产产品的品质和生产效率，主要的提升是 误报警率的下降、微弱特征的识别率和检查结果分类的精准化。

深度学习在互联网领域和学术研究领域主要是模型算法开发为主：

<img src="%E9%99%84%E5%BD%95%EF%BC%9A1.%20TensorFlow.NET%20%E5%9C%A8%E5%B7%A5%E4%B8%9A%E5%BA%94%E7%94%A8%E4%B8%AD%E7%9A%84%E4%BC%98%E5%8A%BF.assets/1610692706359.png" alt="1610692706359" style="zoom:50%;" />

但在工业现场应用时，更多的需要考虑现场部署和配套工具的开发：

<img src="%E9%99%84%E5%BD%95%EF%BC%9A1.%20TensorFlow.NET%20%E5%9C%A8%E5%B7%A5%E4%B8%9A%E5%BA%94%E7%94%A8%E4%B8%AD%E7%9A%84%E4%BC%98%E5%8A%BF.assets/1610692775380.png" alt="1610692775380" style="zoom:50%;" />

很多细节问题在实际应用被放大，成为主要开发项，网络模型的关注度反而下降。





#### 3.1.2 工业视觉应用深度学习详解

工业视觉中应用深度学习相比传统深度学习主要有以下8个方面的差异点：

<img src="%E9%99%84%E5%BD%95%EF%BC%9A1.%20TensorFlow.NET%20%E5%9C%A8%E5%B7%A5%E4%B8%9A%E5%BA%94%E7%94%A8%E4%B8%AD%E7%9A%84%E4%BC%98%E5%8A%BF.assets/1610693574657.png" alt="1610693574657" style="zoom: 67%;" />



接下来，我们逐个详细进行解析。



**① 图像采集对比**

工业图像的采集端种类多样，成像格式也多种多样：有线扫（LineScan）相机，成像是细长的尺寸（例如 2048 pixel × 50000 pixel）；也有传统的面阵（AreaScan）相机，成像是传统的灰度图像；特殊的3D相机，成像是点云数据图；还有红外相机、紫外相机、偏振相机等等。工业图像以 8bit 灰度图为主，尺寸各异，无法投入现有深度学习模型直接使用。

<img src="%E9%99%84%E5%BD%95%EF%BC%9A1.%20TensorFlow.NET%20%E5%9C%A8%E5%B7%A5%E4%B8%9A%E5%BA%94%E7%94%A8%E4%B8%AD%E7%9A%84%E4%BC%98%E5%8A%BF.assets/1610696267150.png" alt="1610696267150" style="zoom:67%;" />

而传统非工业领域的采集端比较单一，一般有手机摄像头或者网络摄像头（或安防监控），都是普通的彩色成像芯片，图像尺寸多为方正的，大多数深度学习模型也是基于这类图像进行开发和训练的，适用性高。

<img src="%E9%99%84%E5%BD%95%EF%BC%9A1.%20TensorFlow.NET%20%E5%9C%A8%E5%B7%A5%E4%B8%9A%E5%BA%94%E7%94%A8%E4%B8%AD%E7%9A%84%E4%BC%98%E5%8A%BF.assets/1610696429462.png" alt="1610696429462" style="zoom:67%;" />



**② 成像环境差异**

**工业图像的主要特点**：工业领域，不管是3C、半导体、面板、SMD、汽车，还是饮料食品、标签、纺织等，不管检测对象是表面瑕疵划痕污染、印刷喷涂异常、组装灌装测量，还是读码和字符识别，都有一个和我们日常手机摄影头拍摄照片不一样的地方。那就是，工业取像使用更稳定的视觉硬件，包括工业相机、工业镜头和工业光源，会尽可能地打造一个稳定的成像环境，图像的背景和目标一般在位置分布和灰度上不会有太多动态的变化，但是不排除复杂的纹理特征和复杂的轮廓边界，而这也是深度学习最契合的应用场景。因此，基于工业上的图像集的特点，如果有较好推理应用的模成熟型的话，在训练好的模型基础上，做迁移学习，可能会有意外的好效果。 

<img src="%E9%99%84%E5%BD%95%EF%BC%9A1.%20TensorFlow.NET%20%E5%9C%A8%E5%B7%A5%E4%B8%9A%E5%BA%94%E7%94%A8%E4%B8%AD%E7%9A%84%E4%BC%98%E5%8A%BF.assets/1610696577978.png" alt="1610696577978" style="zoom:67%;" />

典型的工业成像效果如下：

<img src="%E9%99%84%E5%BD%95%EF%BC%9A1.%20TensorFlow.NET%20%E5%9C%A8%E5%B7%A5%E4%B8%9A%E5%BA%94%E7%94%A8%E4%B8%AD%E7%9A%84%E4%BC%98%E5%8A%BF.assets/1610696620179.png" alt="1610696620179" style="zoom:67%;" />

而传统领域的图像，大多有复杂的背景和动态的光线变化，同时伴随大量干扰和扭曲形变等，下图是典型的传统领域的图像特点：

<img src="%E9%99%84%E5%BD%95%EF%BC%9A1.%20TensorFlow.NET%20%E5%9C%A8%E5%B7%A5%E4%B8%9A%E5%BA%94%E7%94%A8%E4%B8%AD%E7%9A%84%E4%BC%98%E5%8A%BF.assets/1610696839071.png" alt="1610696839071" style="zoom:67%;" />



**③ 负样本数量不足**

**负样本严重不足**：正常的工业生产中，良品率一般是非常高的（>95%），因此负样本的收集非常困难，有些品质要求严格的产品，可能1个月只会产生10几个不良，这样就对训练集的均衡提出了挑战。需要自主开发图像预处理算法对样本进行增强，不能局限于 TensorFlow 或 OpenCV 自带的的一些传统的图像集样本增强算法。有时候甚至会减少或者取消预测集和测试集，以最大限度地喂给模型训练。另一方面，生产现场也是允许前期一定的测试成本和评价周期，允许粗糙版本先上线，边生产边优化升级。 

这种情况下，一般定制化的样本增强和迁移学习，可以针对性地解决样本均衡问题。

<img src="%E9%99%84%E5%BD%95%EF%BC%9A1.%20TensorFlow.NET%20%E5%9C%A8%E5%B7%A5%E4%B8%9A%E5%BA%94%E7%94%A8%E4%B8%AD%E7%9A%84%E4%BC%98%E5%8A%BF.assets/1610697051154.png" alt="1610697051154" style="zoom:67%;" />



**④ 工业系统环境**

当前生产环境的工业软件主要有以下特点：

1. 封闭性和保密性，数据敏感，无法接入外部互联网；
2. 整体软件基础架构自主开发；
3. 运行速度和稳定性要求高，离线单机设备多；

**深度学习如何适配老旧的系统**：众所周知，因为设备更新和维护成本非常高（各种卡槽等），工业设备的迭代速度是很低的，设备稳定性很好。这也造成一个问题，目前的工业领域的PC系统大多老旧，虽然是很稳定的工控机，抗击恶劣环境和连续工业性能很强，但PC配置大多较低，系统版本也不高。经常会遇到10年前的双核处理器，搭配 win2000 操作系统，这也给深度学习的部署应用提出了一些难题。

一般的解决方案是通过在设备外部搭建深度学习服务器，和产线设备组成内网文件共享和实时通讯，实时地读取设备内生成的图像进行推理，并将推理结果通过网络反馈设备。 

<img src="%E9%99%84%E5%BD%95%EF%BC%9A1.%20TensorFlow.NET%20%E5%9C%A8%E5%B7%A5%E4%B8%9A%E5%BA%94%E7%94%A8%E4%B8%AD%E7%9A%84%E4%BC%98%E5%8A%BF.assets/1610697249522.png" alt="1610697249522" style="zoom:67%;" />

POST 组网通讯方式如下：

<img src="%E9%99%84%E5%BD%95%EF%BC%9A1.%20TensorFlow.NET%20%E5%9C%A8%E5%B7%A5%E4%B8%9A%E5%BA%94%E7%94%A8%E4%B8%AD%E7%9A%84%E4%BC%98%E5%8A%BF.assets/1610697346599.png" alt="1610697346599" style="zoom:67%;" />



**⑤ 工业视觉编程环境**

我们来看下 TIOBE 2021年1月 的 TOP 编程语言排行榜，从下图中可以看到，Python 占据了 第 3 名，C# 在 第 5 名。在深度学习的科研和互联网领域中，目前是以 Python 语言为主流，但是在传统的工业生产环境中，依然是 微软 .NET 的天下，其中主要的开发语言为 C#。

<img src="%E9%99%84%E5%BD%95%EF%BC%9A1.%20TensorFlow.NET%20%E5%9C%A8%E5%B7%A5%E4%B8%9A%E5%BA%94%E7%94%A8%E4%B8%AD%E7%9A%84%E4%BC%98%E5%8A%BF.assets/1610699460228.png" alt="1610699460228" style="zoom:67%;" />

**模型部署推理如何和现有程序集成**：工业上使用的检查程序大多数是基于.NET或者C++，和较流行的 python 不同，而且开发者也无法再切换原有程序的语言，因为涉及到 PC 内很多运动控制、各种板卡和通讯交互等外部依赖的商业类库，更换语言的成本很高，也几乎不可能完成。目前一般2种方式对应：通过post通讯，python上训练和部署，并通过flask服务和原程序通讯交互；或者采用C++版本或者.net版本支持GPU的TensorFlow扩展，直接集成到现在程序中，进行训练和推理，实时内存中共享图像变量和结果。个人建议采用第2种方式，开发起来更快高效。 

工业 .NET 环境下部署深度学习 TensorFlow 一般有2种方式。



**方式一、服务器Python + 客户端 .NET 通讯交互方式**

**原理简述**

训练：Python GPU版本 TensorFlow

推理：Python CPU or GPU版本 TensorFlow

模型部署：Python 加载模型，通过 Post 通讯，接收图像进行推理，返回 Json 格式结果

**优缺点**

优点：服务器/客户端分离，支持多客户端并行运算

缺点：需要安装和运行Python和.NET 2种框架，部署流程和架构复杂

<img src="%E9%99%84%E5%BD%95%EF%BC%9A1.%20TensorFlow.NET%20%E5%9C%A8%E5%B7%A5%E4%B8%9A%E5%BA%94%E7%94%A8%E4%B8%AD%E7%9A%84%E4%BC%98%E5%8A%BF.assets/1610699866924.png" alt="1610699866924" style="zoom:67%;" />

<img src="%E9%99%84%E5%BD%95%EF%BC%9A1.%20TensorFlow.NET%20%E5%9C%A8%E5%B7%A5%E4%B8%9A%E5%BA%94%E7%94%A8%E4%B8%AD%E7%9A%84%E4%BC%98%E5%8A%BF.assets/1610699883143.png" alt="1610699883143" style="zoom:67%;" />



**方式二、TensorFlow.NET 统一框架训练和推理（推荐方式）**

如何解决不同语言框架开发之间的兼容，如何快速有效地进行模型部署，接下来，我们介绍 Google 官方推荐 .NET 开发者使用的，同时也是 微软 ML.NET 的底层深度学习框架之一的，来自 SciSharp 的 TensorFlow.NET 。

**原理简述**

训练：GPU 版本 TensorFlow.NET

推理：CPU or GPU 版本 TensorFlow.NET

模型部署：TensorFlow.NET GPU版本 训练出的模型直接调用

**优缺点**

优点：

TensorFlow在.NET环境下的GPU支持

模型训练和部署 可以在同1套程序中集成，无需外部通讯

Google官方推荐.NET开发者使用，同时作为ML.NET的底层深度学习框架

<img src="%E9%99%84%E5%BD%95%EF%BC%9A1.%20TensorFlow.NET%20%E5%9C%A8%E5%B7%A5%E4%B8%9A%E5%BA%94%E7%94%A8%E4%B8%AD%E7%9A%84%E4%BC%98%E5%8A%BF.assets/1610700014447.png" alt="1610700014447" style="zoom:67%;" />

<img src="%E9%99%84%E5%BD%95%EF%BC%9A1.%20TensorFlow.NET%20%E5%9C%A8%E5%B7%A5%E4%B8%9A%E5%BA%94%E7%94%A8%E4%B8%AD%E7%9A%84%E4%BC%98%E5%8A%BF.assets/1610700031058.png" alt="1610700031058" style="zoom:67%;" />



**⑥ 工业视觉 网络模型特点**

**模型不需要前沿 需要稳定高效**：工业上的算法应用一般略微落后于前沿技术，以稳定高效为主。像图像处理方面一般还是使用一些传统的经典的算法，以深度学习做图像分类为例，简单的项目使用 LeNet 和 AlexNet 网络就足够，复杂的项目一般使用到 VGG Net 就可以。但也有部分较前沿的技术应用，比如超分算法，对图像进行扩展以增加细节，帮助提升分类精准性。 

<img src="%E9%99%84%E5%BD%95%EF%BC%9A1.%20TensorFlow.NET%20%E5%9C%A8%E5%B7%A5%E4%B8%9A%E5%BA%94%E7%94%A8%E4%B8%AD%E7%9A%84%E4%BC%98%E5%8A%BF.assets/1610700181223.png" alt="1610700181223" style="zoom:67%;" />



**⑦ 开发：算法落地的配套工具开发量占比高**

**算法落地的配套工具开发量占比高**：工业中一个完整项目的落地，需要交付一整套系统，其中生产人员的便捷应用和人性化的交互UI也是比较重要的。因此，深度学习在工业现场应用，很大一部分开发工作量在于配套的工具。例如，数据集标注制作、模型训练、模型快速部署和训练推理过程的可视化，这些都需要封装成易用稳定的工具，交付客户时可以让无编程经验的客户也能快速开展深度学习的业务。

<img src="%E9%99%84%E5%BD%95%EF%BC%9A1.%20TensorFlow.NET%20%E5%9C%A8%E5%B7%A5%E4%B8%9A%E5%BA%94%E7%94%A8%E4%B8%AD%E7%9A%84%E4%BC%98%E5%8A%BF.assets/1610700427323.png" alt="1610700427323" style="zoom:67%;" />



**⑧ 算法特点 ： 传统算法为主 深度学习辅助**  

**传统算法为主 深度学习辅助**：虽然现在深度学习技术已经看上去无所不能，但在工业应用上，还是主要以传统算法为主，深度学习辅助的模式。这并非是孰是孰非的问题，而是当前时期，传统视觉算法在兼顾运算速度、像素计算精度和算法开发速度上，还是略微占优势。而深度学习一般作为补充，弥补传统算法在复杂纹理和复杂特征描述上的不足，将传统算法达到的90%准确率，助推至95%。

<img src="%E9%99%84%E5%BD%95%EF%BC%9A1.%20TensorFlow.NET%20%E5%9C%A8%E5%B7%A5%E4%B8%9A%E5%BA%94%E7%94%A8%E4%B8%AD%E7%9A%84%E4%BC%98%E5%8A%BF.assets/1610700512301.png" alt="1610700512301" style="zoom:67%;" />





#### 3.1.3 TensorFlow.NET 视觉应用解决方案

接下来，我们用一个经典的深度学习案例演示下 TensorFlow.NET 下的 MNIST DNN（Deep Neural NetWork）。

DNN 在 TensorFlow2.0 中的一般流程：

Step - 1：数据加载、归一化和预处理；

Step - 2：搭建深度神经网络模型；

Step - 3：定义损失函数和准确率函数；

Step - 4：模型训练；

Step - 5：模型预测推理，性能评估。



**经典案例，MNIST 数据集采用 TensorFlow 2.x 的 Keras 模式下的 DNN 网络**，如下：

<img src="附录：1. TensorFlow.NET 在工业应用中的优势.assets/image-20210115230557799.png" alt="image-20210115230557799" style="zoom:67%;" />



对应上述流程的实现代码片段如下：

<img src="附录：1. TensorFlow.NET 在工业应用中的优势.assets/image-20210115230732622.png" alt="image-20210115230732622" style="zoom:67%;" />



我们可以看到，终端正确输出了 DNN 模型的结构。同时训练过程中实时地打印出了简洁的训练中间数据，loss 在合理地下降，accuracy 提高，最终的测试集的准确率为 0.9295，基本属于一个比较良好的训练结果。

<img src="附录：1. TensorFlow.NET 在工业应用中的优势.assets/image-20210115230917328.png" alt="image-20210115230917328" style="zoom:67%;" />



这是刚才看到的流程图，在算法学术研发领域，这可能就是整个过程了，但在工业中，这不是一个完整的解决方案，你还需要开发大量的配套工具和类库封装。大量的细化交互开发的工作，才能给工业现场应用工具的人员带来最舒适的使用体验。

<img src="附录：1. TensorFlow.NET 在工业应用中的优势.assets/image-20210115232156543.png" alt="image-20210115232156543" style="zoom:67%;" />



TensorFlow.NET 深度学习框架基于 .NET Standard 2.0 标准框架，同时适配 .NET Framework 、.NET Core 及 **.NET 5**。

<img src="附录：1. TensorFlow.NET 在工业应用中的优势.assets/image-20210115232608841.png" alt="image-20210115232608841" style="zoom:67%;" />

通过 TensorFlow.NET，你可以轻松打造一套可视化交互式的深度学习集成软件，支持 GPU 训练和推理，同时通过 DLL 引用即可快速完成工业生产部署，所有的操作都在统一的 .NET 环境进行，可以将各操作类库标准化封装，部署便利性和稳定性极高。

下述是作者基于 TensorFlow.NET 开发的一套机器视觉的深度学习通用平台，集成了 OpenCV 的大量算子和深度学习模块，同时实现大量可视化操作，可以直接交付现场生产环境使用，达到深度学习无基础快速现场应用的目的。

<img src="%E9%99%84%E5%BD%95%EF%BC%9A1.%20TensorFlow.NET%20%E5%9C%A8%E5%B7%A5%E4%B8%9A%E5%BA%94%E7%94%A8%E4%B8%AD%E7%9A%84%E4%BC%98%E5%8A%BF.assets/image-20200725095414800.png" alt="image-20200725095414800" style="zoom: 67%;" />





#### 3.1.4 .NET 下机器学习的优势分析

除了上面提到的统一平台的便利性，.NET 下机器学习还要哪些优势呢？



**① C# 较 Python 性能大幅提升**

我们通过一个相同数据集的1000轮的线性回归的例子的运行，我们对比 C# 和 Python 的运行速度和内存占用，发现 C# 的速度大约是 Python 的2倍，而内存的使用，C# 只占到 Python 的1/4 ，可以说 TensorFlow 的 C# 版本在速度和性能上同时超过了 Python 版本，因此，在工业现场或者实际应用时，TensorFlow.NET 除了部署上的便利，更有性能上的杰出优势。

下述2个图是具体的对比运行示意图：

<img src="二、TensorFlow.NET API-5. Linear Regression.assets/20200627154950.jpg" alt="20200627154950.jpg" style="zoom:80%;" />



<img src="二、TensorFlow.NET API-5. Linear Regression.assets/python-dotnet-comparision.gif" alt="python-dotnet-comparision" style="zoom:80%;" />



**② GPU 环境无需部署 一键使用**

详细文章请访问路径：[https://github.com/SciSharp/TensorFlow.NET-Tutorials/blob/master/%E4%B8%89%E3%80%81%E5%B7%A5%E4%B8%9A%E5%BA%94%E7%94%A8%E4%B8%8E%E6%A1%88%E4%BE%8B-1.%20TensorFlow.NET%20%E5%88%9D%E6%8E%A2.md](<https://github.com/SciSharp/TensorFlow.NET-Tutorials/blob/master/三、工业应用与案例-1. TensorFlow.NET 初探.md>)

（或扫下述二维码转至）

<img src="%E9%99%84%E5%BD%95%EF%BC%9A1.%20TensorFlow.NET%20%E5%9C%A8%E5%B7%A5%E4%B8%9A%E5%BA%94%E7%94%A8%E4%B8%AD%E7%9A%84%E4%BC%98%E5%8A%BF.assets/image-20200725232343980.png" alt="image-20200725232343980" style="zoom:67%;" />



你是否踩过 GPU 环境部署中 Cuda 和 cuDNN （版本多，各版本间匹配复杂）的坑，是否为如何进行深度学习 GPU 训练软件的移植和快速应用而烦恼，那么本文就是为了解决这些问题而制作的，**一键部署GPU，最大化体现.NET优势，彻底解决GPU环境配置的繁琐问题，让你专注于深度学习算法和模型的开发**。

<img src="附录：1. TensorFlow.NET 在工业应用中的优势.assets/image-20210115233358042.png" alt="image-20210115233358042" style="zoom:67%;" />



本文主要适用于下述情况：

- 一键部署深度学习训练软件，无需安装复制的Cuda、cuDNN和配置环境变量等；
- 希望将GPU加速的训练软件整体打包、移植使用，软件安装绿色简便化；
- GPU训练版本软件开发完交付客户，避免因客户PC配置差异导致的软件无法正常使用；
- **简单地复制粘贴，即可一键完成GPU训练环境部署**，确保GPU环境安装“0”差错；
- 需要在一台机器上 **同时** 跑多个版本TF和多个版本Cuda的开发环境

<img src="%E9%99%84%E5%BD%95%EF%BC%9A1.%20TensorFlow.NET%20%E5%9C%A8%E5%B7%A5%E4%B8%9A%E5%BA%94%E7%94%A8%E4%B8%AD%E7%9A%84%E4%BC%98%E5%8A%BF.assets/image-20200725232054006.png" alt="image-20200725232054006" style="zoom:80%;" />

**原理说明：**

利用.net的封装优势，将 tensorflow.dll、TensorFlow.NET.dll 及 NVIDPU 相关必要的 DLL 全部提取，拷贝至应用程序相同目录下，伴随可执行文件打包、移植使用，实现 GPU 环境跟随主程序版本打包应用的效果。

<img src="附录：1. TensorFlow.NET 在工业应用中的优势.assets/image-20210115233534419.png" alt="image-20210115233534419" style="zoom:67%;" />

<img src="附录：1. TensorFlow.NET 在工业应用中的优势.assets/image-20210115233554635.png" alt="image-20210115233554635" style="zoom:67%;" />







### 3.2 工业时间序列预测领域应用

这个“煤矿探头集群监控系统”的案例来自网友 “矿工学编程” ，使用 TensorFlow.NET 对煤矿矿区大量分布的探头采集的数据进行时间序列预测，已经成功在煤矿产业现场生产中持续应用，并得到了行业内的肯定。

<img src="附录：1. TensorFlow.NET 在工业应用中的优势.assets/image-20210120232504782.png" alt="image-20210120232504782" style="zoom:67%;" />



#### 3.2.1 项目背景 - 煤矿行业 .NET 应用优势

​    当前国家大力推行工业化与信息化融合，在此良好的环境下“两化融合”得到高速发展。

​    过去十几年，.NET 技术在煤矿工业化进程中起到了重要作用，尤其是煤矿各类安全生产辅助系统几乎都是 .NET 产品，稳定运行十多年很少出错，默默为煤矿的安全发展保驾护航。不同于互联网产品，煤矿产品追求安全、稳定、少迭代、易用性和维护简单。当前 Linux 服务器的使用呈现爆炸势增长，煤矿行业也不例外。

​    .NET Core 框架具有高性能、跨平台、部署灵活、兼容性好和微软大厂维护等优秀特性。2014年开源至今，6年的时间里 .NET Core 各种优秀的开源框架不断补齐 .NET 在各种技术场景的应用，生态也在不断完善。因此，选用 .NET Core 框架作业煤矿业务系统的开发，正好满足行业的需求。

​    2020年是病毒肆虐的一年，也是信息化技术空前需要的一年。 这一年对于我们团队来说也是挑战的一年，我们很幸运地接到了本专业的数据项目。带着兴奋与挑战，我们使用纯 .NET 技术成功地研发出了完整成熟的 AI 数据分析产品，得到了行业各方的肯定、中国煤矿工业协会的奖项和论文发表，主页为我们坚持 .NET 技术坚定了信心。



#### 3.2.2 客户需求 - 矿区环境时序数据预测

​    XXX 公司2018年采购了一套监控系统，监控矿区作业点的环境数据。探头数量为 500-700 个左右。XXX 公司要求每1分钟对数据进行采集、入库，提供日数据查询并生成曲线和1小时的时序预测，部门产生的报表也需要上传数据库。同时，根据行业标准，将部分探头数据配合上传的报表转化为标准数据，制作日、周、月报表和一周AI数据预测报告。而系统运行过程中产生的实时数据、历史数据和预测数据要求收集并可以查看。



#### 3.2.3 业务分析

   根据客户需求，我们处理系统的重点是：大量数据存储、数据转化 ETL、实时&周期数据查询和AI数据分析。那么我们业务模型也就清晰了，业务流程如下图。   

<img src="附录：1. TensorFlow.NET 在工业应用中的优势.assets/20210102142356227.png" alt="img" style="zoom:80%;" />

​    将大量的探头历史数据分库分表存到历史数据库中，报表数据存到业务系统数据中，根据探头历史数据和报表数据的关系 ETL 到数据仓库中。数据仓库根据数据分析需求通过 sql 生成分析数据集，利用 .NET 的AI分析库 TensorFlow.NET 提供时序预测模型进行 AI 预测，最后将 AI 预测结果写到业务系统的数据库中。



#### 3.2.4 技术选型 和 详细方案说明

​    **1、数据清洗 - xml 文件处理**

​    原监控系统中有专门的数据交换软件，生成交换数据格式为 xml。我们只需要根据对方提供的协议文档即可正确地解析数据。xml 数据主要为2个文件，一个是设备基本信息文件带时间戳（SBM202012291653.XML），另一个是设备数据值文件带时间戳（SJZ202012291653.XML）。

​    1）xml 数据处理，我采用解析完就删除的策略。先扫描文件，按照文件头归类文件，先删除时间戳复制到另外一个文件夹，再根据时间戳先后写入，数据写完立即删除；

​    2）设备基本信息 xml 文件，由于设备基本信息 xml 文件变化频率较低，故采用覆盖式存储方式（表中永远是最新的数据）；

​    3）设备数据值 xml 文件，则按照时序进行存储。

​    **2、历史数据存储**

​    数据量按照数据值文件来计算为 “60分钟 * 24小时 * 800个（比 XXX 公司给的探头数多出100个）= 1152000条数据”，整体大概是一天115万条数据。我们这里采用的是日分表、月分库、年分文件夹的策略进行存储。选用新生团队开源的 NewLife.XCode 数据库中间件进行分库分表数据存储操作。NewLife.XCode 同时支持 Fx 和 Core，数据库支持支持 Oracle、SqlServer、MySql、SQLite 等主流关系型数据库。我这里采用的是 SQLite 进行历史数据存储。将数据采集做成 Windows 服务，设置服务为自动启动和自动重启。

​    1）分库规则：DataBaseName_yyyyMM命 名方式进行分库操作；

​    2）分表规则：TableName_yyyyMMdd 命名方式进行分表操作；

​    3）设备数据值日表：按照当日实际采集的数据进行累加写入；

​    4）设备基本信息日表：则按照最新的设备信息井下覆盖写入；

​    5）设备数据值临时表：仅存放2-3天的探头值数据。

 

<img src="附录：1. TensorFlow.NET 在工业应用中的优势.assets/2021010214480683.jpg" alt="img" style="zoom:80%;" />

 

<img src="附录：1. TensorFlow.NET 在工业应用中的优势.assets/20210102142836489.png" alt="img" style="zoom:80%;" />

​    **3、业务&报表数据存储**

​    业务系统中含 Excel 数据采集，以及考虑读写分离，因此我们选用 WTM 框架进行构建业务系统。WTM 框架，支持一键生成增删改查、导入导出和批量操作代码，支持分离 (React+AntD,Vue+Element) 和不分离 (LayUI) 两种模式，提供了用户、角色、用户组、菜单和日志等常用模块，支持读写分离和数据库分库。我们这里采用 Sql server 作为业务系统的主数据库。

​    1）表设计尽量按照对方原有的 Excel 的样式进行模型设计，利用 WTM 的代码生成器自动生成 CURD 页面、带报错信息的 Excel 导入页面和导出，如果报表复杂，用 WTM 内置的 Excel 处理库进行处理；

​    2）在 appsettings.json 的 ConnectionStrings 根据 WTM 的数据库配置规则，配置 SQL server的读写分离；

​    3）WTM 提供的 cookie 、 JWT 混合身份认证机制和 swagger 等可以帮助大家快速开发。

​    **4、数据 ETL**

​    我理解的 ETL 就是数据转化，根据业务的实际情况把别的表中的数据抽到数据仓中，然后按照一定的条件重新拼成一张新表。新表的特点就是相比之前的业务表，字段明显多了。例如以前的业务表可能就只有一个部门的数据，经过 ETL 之后新的表中就按条件汇集了多个部门的数据，甚至部分数据的值也因重新计算而发生改变。这里 ETL 我采用了蚂蚁调度 AntJob 框架，叫做 AntJob .NET 框架分布式任务调度系统。AntJob 的核心是蚂蚁算法**：**把任意大的数据拆分成为小块，采用蚂蚁搬家的策略分布计算每一小块，时一个纯 .NET 打造的重量级大数据实时计算平台。

   

<img src="附录：1. TensorFlow.NET 在工业应用中的优势.assets/01482531c438c3a1b34d876fa94955a6.png" alt="image.png" style="zoom:80%;" />

​     **5、AI 时序预测**

​    这里我选用了 TensorFlow.NET 用于提供AI算法模型。我这里的 AI 计算场景是2种不同的数值预测，一种是对探头的数据进行时序预测，另一种是对多条件进行分析（多个条件为计算和分析某一列的数）。

​    1）时序预测：这个很好理解，数据只有时间和值2个维度。这里探头值的大小如果在正常情况下，会受不同时间的作业情况影响。因此如果不是特殊的数据情况，前面设计的临时表用于存放2-3天的探头历史数据就起了作用，可以利用时序模型对探头进行时序预测；

​    2.0）神经网络 or 多元回归：这2种算法都可以用于做数值预测，具体用那种模型要根据实际测试的时候算法模型评估的均方根误差和拟合后的数据误差情况。一般是均方根误差越小越好，但是实际情况可能会存在过拟合的现象。因此，模型做好后，需要用测试数据做一下实测数据和预测数据的拟合情况，看2个模型的曲线的总体走势和计算最大、最小和平均误差。确定好算法之后，再利用任务框架按照周期在凌晨固定时间进行离线计算；

​    2.1）每次计算都重新评估模型，指标达标则使用该模型，不达标则重新计算。计算设置上限次数，如果计算次数达到上限则记录失败记录，利用人工干预调整模型;

​    2.2）计算的结果直接写到业务系统数据库中，预测数据以二进制方式存储 Json 字符串，方便业务系统渲染展示数据预测结果；

​    2.3）可以采用 Keras Tuner 和 AutoML 进行自动算法调优或自动选择算法。

​    2.4）提供数据集选择和自主上传预测环境数据集的功能交互页面，用户可根据自身需求在线做AI计算。

   在2个多月的运行时间里，系统自动进行8次AI任务（每周一次），为30多个作业地点进行值预测，误差率在0.2~9.8%之间，完全满足客户的需求。过程中间仅出现了2次较大的误差，而这2次误差在系统提供的重算功能中，重算后满足了预测计算要求。

<img src="附录：1. TensorFlow.NET 在工业应用中的优势.assets/2021010221200083.jpg" alt="img" style="zoom:80%;" />

   

<img src="附录：1. TensorFlow.NET 在工业应用中的优势.assets/2021010221202237.jpg" alt="img" style="zoom:80%;" />

 

#### 3.2.5 项目总结  

​    本次的系统研发，从数据采集、数据 ETL、业务系统构建以及 AI 分析，.NET Core 都有对应的技术栈，供开发者使用，而且由于是约定大于配置，节省了十分多的学习时间，使用 C# 语言轻松进行开发。遇到业务问题，我们也在 .NET 的技术网络群中询问，一般都有热心的群友出来解决，如果实在难解决的，也会有大佬出来提供解决问题的思路或者帮忙debug，最终完成了“煤矿探头集群监控系统”的研发。目前，.NET Core 已经可以运行在龙芯 CPU，未来全国产化的进程正在一步步靠近，我们会全面拥抱 .NET 投入国产化运营。